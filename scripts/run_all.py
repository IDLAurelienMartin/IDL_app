import subprocess
import sys
from pathlib import Path

# --------------------------
# Configuration
# --------------------------
BASE_DIR = Path(__file__).resolve().parent
PYTHON = sys.executable  # Python du venv actif

# --------------------------
# Fonction pour ex√©cuter un script
# --------------------------
def run_script(script_name: str):
    """
    Ex√©cute un script Python et affiche les logs stdout/stderr.
    """
    script_path = BASE_DIR / script_name
    print(f"\n=== Ex√©cution de {script_name} ===")
    result = subprocess.run([PYTHON, str(script_path)], capture_output=True, text=True)

    # Affichage stdout
    if result.stdout:
        print(result.stdout)

    # Affichage stderr
    if result.stderr:
        print("‚ö†Ô∏è Erreurs / avertissements :")
        print(result.stderr)

# --------------------------
# Script principal
# --------------------------
if __name__ == "__main__":
    # 1Ô∏è‚É£ Pr√©traitement des donn√©es
    run_script("preprocess_stock.py")  # Chargement / nettoyage / OAuth Google Drive

    # 2Ô∏è‚É£ Pr√©paration et g√©n√©ration du cache parquet
    run_script("prepare_data.py")      # Pr√©pare les fichiers .parquet et upload Drive

    # 3Ô∏è‚É£ Fonctions utilitaires (optionnel selon usage)
    run_script("utils_stock.py")       # Fonctions utilitaires pour affichage / totaux

    # 4Ô∏è‚É£ Lancement de l'application Streamlit
    app_path = BASE_DIR.parent / "IDL_app.py"
    print(f"\nüöÄ Lancement de l'application Streamlit : {app_path}")
    subprocess.run([PYTHON, "-m", "streamlit", "run", str(app_path)])
